{"version":3,"sources":["../../../../../packages/miq-dmsjs/src/document/ShareView.jsx","../../../../../packages/miq-dmsjs/src/components.jsx"],"names":["DocumentShareView","props","docSlug","match","params","toast","useContext","ToastCtx","useState","q","setQ","users","setUsers","users_data","document","setDocument","form","useForm","user","useEffect","docServices","detail","then","data","catch","err","debounceGetStaffUsers","useCallback","debounce","getStaffList","results","length","slug","clearUsers","e","usersMatch","filter","u","includes","context","id","title","className","to","url","replace","floating","header","required","name","value","onChange","target","placeholder","isOpen","map","i","onClick","setValue","setUser","role","uploaded_by","patchUser","action","success","message","error","addUser","DocumentUserPermission","permission","perm","setPerm","refreshDocument","newDocument","permissions","Object","values","console","log","can_change_share_permission","preventDefault","patchUserPermission","label","Icon","Icons","Trash","BackToStaffDocumentsLink","docUrls","staff_path","ArrowLeft"],"mappings":"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","file":"static/js/8.c7eed9fd.chunk.js","sourcesContent":["import React, { useCallback, useContext, useEffect, useState } from 'react';\nimport { debounce } from 'lodash';\n\nimport Form, { useForm } from '@miq/form';\nimport { AdminView } from '@miq/adminjs';\nimport { UserCard, Button, IconButton, Icons, Collapse, ToastCtx } from '@miq/components';\n\nimport './share-view.scss';\n\nimport { docServices } from './utils';\nimport { BackToStaffDocumentsLink } from '../components';\n\nexport default function DocumentShareView(props) {\n  const { docSlug } = props.match.params;\n\n  const toast = useContext(ToastCtx);\n\n  const [q, setQ] = useState('');\n  const [users, setUsers] = useState([]);\n  const [document, setDocument] = useState({ users_data: [], users: [] });\n\n  const form = useForm({ user: null });\n\n  useEffect(() => {\n    docServices\n      .detail(docSlug)\n      .then((data) => {\n        setDocument(data);\n      })\n      .catch((err) => {});\n  }, [docSlug]);\n\n  const debounceGetStaffUsers = useCallback(\n    debounce(\n      (q) =>\n        docServices.getStaffList(q).then(({ results }) => {\n          setUsers(results);\n        }),\n      400\n    ),\n    []\n  );\n\n  useEffect(() => {\n    if (!q || q.length < 3) return;\n\n    debounceGetStaffUsers(q);\n  }, [q, debounceGetStaffUsers]);\n\n  // NO DOCUMENT\n  if (!document || !document.slug) return null;\n\n  const setUser = (user) => {\n    if (document.users.includes(user.slug)) return;\n    form.setValue('user', user);\n  };\n\n  const clearUsers = (e) => {\n    setQ(() => '');\n    // setUsers([]);\n  };\n\n  const addUser = ({ slug, name }) => {\n    if (!slug || slug === document.uploaded_by.slug) {\n      return;\n    }\n\n    docServices\n      .patchUser(docSlug, { action: 'add', users: [slug] })\n      .then((data) => {\n        toast.success({ message: `Document shared with ${name}` });\n        setDocument({ ...document, ...data });\n        clearUsers();\n      })\n      .catch((err) => {\n        toast.error({ message: `Something went wrong.\\n Please try again.` });\n        // console.log(err);\n      });\n  };\n\n  const usersMatch = users.filter((u) => !document.users.includes(u.slug));\n\n  return (\n    <Form context={form} id=\"DocumentShareModal\">\n      <AdminView\n        title={\n          <div className=\"d-flex align-items-center\">\n            <BackToStaffDocumentsLink to={props.match.url.replace('share/', '')} className=\"btn-secondary-4 me-1\" />\n            <h2 className=\"text-md\">Partager avec des personnes</h2>\n          </div>\n        }\n        className=\"document-share-view\"\n      >\n        <div className=\"select-user-form mb-3\">\n          <Collapse\n            floating\n            header={\n              <input\n                required\n                name=\"q\"\n                value={q}\n                onChange={(e) => setQ(e.target.value)}\n                placeholder=\"Username, name or email\"\n                className=\"miq-input\"\n              />\n            }\n            isOpen={q.length > 2 && usersMatch.length > 0}\n          >\n            <div className=\"border-1 rounded\">\n              {usersMatch.map((user, i) => (\n                <div\n                  className=\"user-card-wrapper\"\n                  onClick={() => setUser(user)}\n                  role=\"button\"\n                  title={`Partager le document avec ${user.name}`}\n                  key={`${user.slug}-${i}`}\n                >\n                  <UserCard {...{ user }} />\n                  <Button onClick={() => addUser(user)} className=\"btn-primary-3\">\n                    Ajouter\n                  </Button>\n                </div>\n              ))}\n              <div className=\"p-1\">\n                <Button onClick={clearUsers}>Annuler</Button>\n              </div>\n            </div>\n          </Collapse>\n        </div>\n\n        <div className=\"shared-users miq-container pb-3\">\n          <p className=\"pb-2\">\n            Le document <span className=\"fw-bold\">{document.title}</span> est actuellement partag√© avec:\n          </p>\n\n          <div className=\"shared-user\">\n            <UserCard {...{ user: document.uploaded_by }} />\n            <span className=\"text-muted\">Owner</span>\n          </div>\n          {document.users_data.map((user) => (\n            <DocumentUserPermission\n              user={user}\n              document={document}\n              setDocument={setDocument}\n              toast={toast}\n              key={user.slug}\n            />\n          ))}\n        </div>\n      </AdminView>\n    </Form>\n  );\n}\n\nconst DocumentUserPermission = ({ user, document, ...props }) => {\n  const { toast } = props;\n  const [perm, setPerm] = useState(user.permission || 'VIEW');\n\n  if (!user || !document) return null;\n\n  const refreshDocument = (newDocument) => {\n    if (!props.setDocument) return;\n    props.setDocument({ ...document, ...newDocument });\n  };\n\n  const setDocumentPermission = (e) => {\n    const { value } = e.target;\n    e.preventDefault();\n\n    docServices\n      .patchUserPermission(document.slug, user.slug, value)\n      .then((data) => {\n        setPerm(value);\n        toast.success({ message: 'Permission updated.' });\n        refreshDocument(data);\n      })\n      .catch((err) => {\n        toast.error({ message: `Something went wrong.\\n Please try again.` });\n      });\n  };\n\n  const handleRemove = (props) => {\n    docServices\n      .patchUser(document.slug, { action: 'remove', users: [user.slug] })\n      .then((data) => {\n        toast.success({ message: `Document users updated.` });\n        refreshDocument(data);\n      })\n      .catch((err) => {\n        toast.error({ message: `Something went wrong.\\n Please try again.` });\n        // console.log(err);\n      });\n  };\n\n  const permissions = Object.values(document.permissions);\n  console.log(document);\n\n  return (\n    <div className=\"shared-user\" key={user.slug}>\n      <UserCard {...{ user }} />\n\n      {document.can_change_share_permission && (\n        <div className=\"d-flex align-items-center\">\n          <select\n            value={perm}\n            className=\"miq-select p-1 me-2\"\n            onChange={setDocumentPermission}\n            title=\"Changer la permission\"\n          >\n            {permissions.map((perm) => (\n              <option key={perm.name} value={perm.value}>\n                {perm.label}\n              </option>\n            ))}\n          </select>\n\n          <IconButton\n            onClick={handleRemove}\n            Icon={Icons.Trash}\n            className=\"btn-secondary-4\"\n            title={`Supprimer ${user.name}`}\n          />\n        </div>\n      )}\n    </div>\n  );\n};\n","import React from 'react';\n\nimport { AdminNavLink } from '@miq/adminjs';\nimport { Icons } from '@miq/components';\n\nimport { docUrls } from './document/utils';\n\nexport const BackToStaffDocumentsLink = (props) => {\n  return (\n    <AdminNavLink\n      to={props.to || docUrls.staff_path}\n      Icon={Icons.ArrowLeft}\n      title=\"Retourner aux documents\"\n      className={props.className}\n    />\n  );\n};\n"],"sourceRoot":""}